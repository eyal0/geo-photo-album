<!DOCTYPE html>
<html>
  <head>
    <title>Google Maps JavaScript API v3 Example: Map Simple</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <style type="text/css">
      html, body {
        margin: 0;
        padding: 0;
        height: 100%
      }
      #map_canvas {
        margin: 0;
        padding: 0;
        height: 80%
      }
      body {
        padding: 10px;
        font-size: 62.5%;
        font-family: "Trebuchet MS", "Helvetica", "Arial",  "Verdana", "sans-serif";
      }
    </style>
    <link rel="stylesheet" href="http://jqueryui.com/themes/ui-lightness/jquery.ui.all.css">
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="http://jqueryui.com/jquery-1.7.2.js"></script>
    <script type="text/javascript" src="http://jqueryui.com/ui/jquery.ui.core.js"></script>
    <script type="text/javascript" src="http://jqueryui.com/ui/jquery.ui.widget.js"></script>
    <script type="text/javascript" src="http://jqueryui.com/ui/jquery.ui.mouse.js"></script>
    <script src="http://jqueryui.com/ui/jquery.ui.slider.js"></script>
    <script type="text/javascript" src="http://jqueryui.com/ui/jquery.ui.datepicker.js"></script>
    <!-- <link rel="stylesheet" href="http://jqueryui.com/demos/demos.css"> -->
    <script type="text/javascript">
      var map;
      var routePolyline;
      var gpsPoints = [];
      var tileFiles = {};
      var tilesLoaded = 0;
      var startDateTime;
      var endDateTime;
      function initialize() {
        var myOptions = {
          zoom: 0,
          center: new google.maps.LatLng(0, 0),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map_canvas'),
            myOptions);
        
        var gpsPath;
        
        $.ajaxSetup({ cache:false });

        function degreesToRadians(deg) {
          return deg * (Math.PI / 180);
        }
        
        function bound(value, opt_min, opt_max) {
          if (opt_min != null) value = Math.max(value, opt_min);
          if (opt_max != null) value = Math.min(value, opt_max);
          return value;
        }
        
        function fromLatLngToPoint(latLng, opt_point) {
          var point = opt_point || new google.maps.Point(0, 0);

          point.x = 128 + latLng.lng() * 256 / 360;

          // NOTE(appleton): Truncating to 0.9999 effectively limits latitude to
          // 89.189.  This is about a third of a tile past the edge of the world
          // tile.
          var siny = bound(Math.sin(degreesToRadians(latLng.lat())), -0.9999,
              0.9999);
          point.y = 128 + 0.5 * Math.log((1 + siny) / (1 - siny)) *
              -(256 / (2 * Math.PI));
          return point;
        };

        function mergeSort(A, B, compare, perElem) {
          var ret = [];
          var i = 0;
          var j = 0;
          while(i < A.length && j < B.length) {
            if(compare(A[i], B[j]) <= 0) {
              ret.push(A[i]);
              perElem(A[i]);
              i++;
            } else {
              ret.push(B[j]);
              perElem(B[j]);
              j++;
            }
          }
          while(i < A.length) {
            ret.push(A[i]);
            perElem(A[i]);
            i++;
          }
          while(j < B.length) {
            ret.push(B[j]);
            perElem(B[i]);
            j++;
          }
          return(ret);
        }
        
        function load_polyline(force) {
          if(tilesLoaded > 40) {
            console.debug("reset tiles")
            $.each(tileFiles, function (key, val) {
              tileFiles[key] = 0;
            });
            gpsPoints = [];
            tilesLoaded = 0;
          }
          var start = Date.now();
          //console.debug("start at " + start);
          var zoom_level = map.getZoom();
          var bounds = map.getBounds();
          var sw = bounds.getSouthWest();
          var ne = bounds.getNorthEast();
          var sw_point = fromLatLngToPoint(sw);
          var ne_point = fromLatLngToPoint(ne);
          for(var current_zoom = 0;
              current_zoom <= zoom_level+1;
              current_zoom++) {
            //tile is 2048x2048.  2048 is 2**11.
            var current_west = bound(sw_point.x,0,255) << current_zoom;
            var current_south = bound(sw_point.y,0,255) << current_zoom;
            var current_east = bound(ne_point.x,0,255) << current_zoom;
            var current_north = bound(ne_point.y,0,255) << current_zoom;
            for(var i = Math.floor(current_west/2048); i <= Math.floor(current_east/2048); i++) {
              for(var j = Math.floor(current_north/2048); j <= Math.floor(current_south/2048); j++) {
                var tile_filename = "tiles/" + current_zoom + '/tile_' + current_zoom + '_' + i + '_' + j + '.json';
                if(!tileFiles.hasOwnProperty(tile_filename) || tileFiles[tile_filename]) {
                  continue;
                }
                force = false; //the JSON call will eventually redraw the route
                tileFiles[tile_filename] = 1;
                $.getJSON(tile_filename, function(data) {
                  $.each(data, function(key, val) {
                    if(key == 'path')
                      tilesLoaded++;
                      var new_index = 0;
                      var gpsPoints_index = 0;
                      var newGpsPoints = [];
                      var newPath = [];
                      var newBoundsWest=180, newBoundsNorth=-90, newBoundsSouth=90, newBoundsEast=-180;
                      var start_time = $("#start_datepicker").datepicker("getDate").getTime();
                      var end_time = $("#end_datepicker").datepicker("getDate").getTime();
                      while(new_index < val.length && gpsPoints_index < gpsPoints.length) {
                        if(val[new_index][0] < gpsPoints[gpsPoints_index][0]) {
                          newGpsPoints.push(val[new_index]);
                          var current_time = new Date(val[new_index][1]).getTime();
                          if(start_time <= current_time && current_time < end_time) {
                            newPath.push(new google.maps.LatLng(val[new_index][2], val[new_index][3]));
                            newBoundsSouth = Math.min(val[new_index][2], newBoundsSouth);
                            newBoundsNorth = Math.max(val[new_index][2], newBoundsNorth);
                            newBoundsWest  = Math.min(val[new_index][3], newBoundsWest);
                            newBoundsEast  = Math.max(val[new_index][3], newBoundsEast);
                          }
                          new_index++;
                        } else /*if(val[new_index][0] > gpsPoints[gpsPoints_index][0]) */ {
                          newGpsPoints.push(gpsPoints[gpsPoints_index]);
                          var current_time = new Date(gpsPoints[gpsPoints_index][1]).getTime();
                          if(start_time <= current_time && current_time < end_time) {
                            newPath.push(new google.maps.LatLng(gpsPoints[gpsPoints_index][2], gpsPoints[gpsPoints_index][3]));
                            newBoundsSouth = Math.min(gpsPoints[gpsPoints_index][2], newBoundsSouth);
                            newBoundsNorth = Math.max(gpsPoints[gpsPoints_index][2], newBoundsNorth);
                            newBoundsWest  = Math.min(gpsPoints[gpsPoints_index][3], newBoundsWest);
                            newBoundsEast  = Math.max(gpsPoints[gpsPoints_index][3], newBoundsEast);
                          }
                          gpsPoints_index++;
                        }/* else {
                          //shouldn't arrive here ever
                          newGpsPoints.push(gpsPoints[gpsPoints_index]); //whichever
                          if(start_time <= current_time && current_time < end_time) {
                            newPath.push(new google.maps.LatLng(gpsPoints[gpsPoints_index][2], gpsPoints[gpsPoints_index][3])); //whichever
                          }
                          gpsPoints_index++;
                          new_index++;
                        }*/
                      }
                      while(new_index < val.length) {
                        newGpsPoints.push(val[new_index]);
                        var current_time = new Date(val[new_index][1]).getTime();
                        if(start_time <= current_time && current_time < end_time) {
                          newPath.push(new google.maps.LatLng(val[new_index][2], val[new_index][3]));
                          newBoundsSouth = Math.min(val[new_index][2], newBoundsSouth);
                          newBoundsNorth = Math.max(val[new_index][2], newBoundsNorth);
                          newBoundsWest  = Math.min(val[new_index][3], newBoundsWest);
                          newBoundsEast  = Math.max(val[new_index][3], newBoundsEast);
                        }
                        new_index++;
                      }
                      while(gpsPoints_index < gpsPoints.length) {
                        newGpsPoints.push(gpsPoints[gpsPoints_index]);
                        var current_time = new Date(gpsPoints[gpsPoints_index][1]).getTime();
                        if(start_time <= current_time && current_time < end_time) {
                          newPath.push(new google.maps.LatLng(gpsPoints[gpsPoints_index][2], gpsPoints[gpsPoints_index][3]));
                          newBoundsSouth = Math.min(gpsPoints[gpsPoints_index][2], newBoundsSouth);
                          newBoundsNorth = Math.max(gpsPoints[gpsPoints_index][2], newBoundsNorth);
                          newBoundsWest  = Math.min(gpsPoints[gpsPoints_index][3], newBoundsWest);
                          newBoundsEast  = Math.max(gpsPoints[gpsPoints_index][3], newBoundsEast);
                        }
                        gpsPoints_index++;
                      }
                      gpsPoints = newGpsPoints;
                      routePolyline.setPath(newPath);
                      if($("#auto_zoom")[0].checked)
                        map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(newBoundsSouth, newBoundsWest), new google.maps.LatLng(newBoundsNorth, newBoundsEast)));
                  });
                })
              }
            }
          }
          if(force) { //we must re-draw the route because there were no JSON calls that will do it.
            var newPath = [];
            var newBoundsWest=180, newBoundsNorth=-90, newBoundsSouth=90, newBoundsEast=-180;
            var start_time = $("#start_datepicker").datepicker("getDate").getTime();
            var end_time = $("#end_datepicker").datepicker("getDate").getTime();
            for(var gpsPoints_index = 0; gpsPoints_index < gpsPoints.length; gpsPoints_index++) {
              var current_time = new Date(gpsPoints[gpsPoints_index][1]).getTime();
              if(start_time <= current_time && current_time < end_time) {
                newPath.push(new google.maps.LatLng(gpsPoints[gpsPoints_index][2], gpsPoints[gpsPoints_index][3]));
                newBoundsSouth = Math.min(gpsPoints[gpsPoints_index][2], newBoundsSouth);
                newBoundsNorth = Math.max(gpsPoints[gpsPoints_index][2], newBoundsNorth);
                newBoundsWest  = Math.min(gpsPoints[gpsPoints_index][3], newBoundsWest);
                newBoundsEast  = Math.max(gpsPoints[gpsPoints_index][3], newBoundsEast);
              }
            }
            routePolyline.setPath(newPath);
            if($("#auto_zoom")[0].checked)
              map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(newBoundsSouth, newBoundsWest), new google.maps.LatLng(newBoundsNorth, newBoundsEast)));
          }
        }
        var polyOptions = {
          path: new google.maps.MVCArray(),
          strokeColor: '#000000',
          strokeOpacity: 1.0,
          strokeWeight: 3
        }
        routePolyline = new google.maps.Polyline(polyOptions);
        routePolyline.setMap(map);
        $.getJSON("tile_info.json", function(data) {
          $.each(data, function(key, val) {
            if(key == "tiles") {
              $.each(val, function (index, tile_filename) {
                tileFiles[tile_filename] = 0;
              });
            } else if(key == "start_datetime") {
              startDateTime = new Date(val);
            } else if(key == "end_datetime") {
              endDateTime = new Date(val);
            }
          });
          google.maps.event.addListener(map, 'bounds_changed', load_polyline);
          { 
            { //extend the slider
              $.ui.slider.prototype._slide = function ( event, index, newVal ) {
                var otherVal,
                  newValues,
                  allowed;

                if ( this.options.values && this.options.values.length ) {
                  otherVal = this.values( index ? 0 : 1 );
                  if ( newVal !== this.values( index ) ) {
                    newValues = this.values();
                    newValues[ index ] = newVal;
                    // A slide can be canceled by returning false from the slide callback
                    allowed = this._trigger( "slide", event, {
                      handle: this.handles[ index ],
                      value: newVal,
                      values: newValues
                    } );
                    otherVal = this.values( index ? 0 : 1 );
                    if ( allowed !== false ) {
                      this.values( index, newVal, true );
                    }
                  }
                } else {
                  if ( newVal !== this.value() ) {
                    // A slide can be canceled by returning false from the slide callback
                    allowed = this._trigger( "slide", event, {
                      handle: this.handles[ index ],
                      value: newVal
                    } );
                    if ( allowed !== false ) {
                      this.value( newVal );
                    }
                  }
                }
              }
            }
            Date.prototype.clone = function() { return new Date(this.getTime()); };
            Date.prototype.truncateDate = function() { this.setHours(0); this.setMinutes(0); this.setSeconds(0); this.setMilliseconds(0); };
            Date.prototype.addDays = function(days) { this.setDate(this.getDate() + days); return this; }
            Date.prototype.daysUntil = function(targetDate) { //returns integer number of days, as if the H:M:S didn't exist
              var days = Math.floor((targetDate.getTime() - this.getTime())/1000/60/60/24); //a guess
              var testDate = startDate.clone().addDays(days);
              while(testDate.getDate() != targetDate.getDate() || testDate.getMonth() != targetDate.getMonth() || testDate.getYear() != targetDate.getYear()) {
                if(testDate < targetDate) {
                  days++;
                } else {
                  days--;
                }
                testDate = startDate.clone().addDays(days);
              }
              return(days);
            }
            var startDate = startDateTime.clone();
            startDate.truncateDate();
            var endDate = endDateTime.clone();
            endDate.truncateDate();
            var days = startDate.daysUntil(endDate);
            $("#date_slider").slider({animate: true, "step": 1, min: 0, max: days+1, values: [0, days+1], range: true,
                                      slide: function(event, ui) {
                                        if(ui.values[0] >= ui.values[1]) {
                                          if(ui.handle == $("#date_slider a")[0]) {
                                            if(ui.value == days+1) return(false);
                                            $("#date_slider").slider("values", 1, ui.value+1);
                                            ui.values[0] = ui.value;
                                            ui.values[1] = ui.value+1;
                                          } else {
                                            if(ui.value == 0) return(false);
                                            $("#date_slider").slider("values", 0, ui.value-1);
                                            ui.values[0] = ui.value-1;
                                            ui.values[1] = ui.value;
                                          }
                                        }
                                        if($("#start_datepicker").datepicker("getDate").getTime() != startDate.clone().addDays(ui.values[0]).getTime())
                                          $("#start_datepicker").datepicker("setDate", startDate.clone().addDays(ui.values[0]));
                                        if($("#end_datepicker").datepicker("getDate").getTime() != startDate.clone().addDays(ui.values[1]-1).getTime())
                                          $("#end_datepicker").datepicker("setDate", startDate.clone().addDays(ui.values[1]-1));
                                        load_polyline(true);
                                      }
                                     });
            $("#start_datepicker").datepicker({appendText: "(yyyy-mm-dd)", dateFormat: "yy-mm-dd", minDate: startDateTime, maxDate: endDateTime, defaultDate: startDateTime,
                                               onSelect: function(dateText, inst) {
                                                 if($("#start_datepicker").datepicker("getDate").getTime() != startDate.clone().addDays($("#date_slider").slider('values', 0)).getTime())
                                                   $("#date_slider").slider("values", 0, startDateTime.daysUntil($("#start_datepicker").datepicker("getDate")));
                                                 load_polyline(true);
                                               }
                                              });
            $("#start_datepicker").datepicker("setDate", startDateTime);
            $("#end_datepicker").datepicker({appendText: "(yyyy-mm-dd)", dateFormat: "yy-mm-dd", minDate: startDateTime, maxDate: endDateTime, defaultDate: endDateTime,
                                             onSelect: function(dateText, inst) {
                                               if($("#end_datepicker").datepicker("getDate").getTime() != startDate.clone().addDays($("#date_slider").slider('values', 1)-1).getTime())
                                                 $("#date_slider").slider("values", 1, startDateTime.daysUntil($("#end_datepicker").datepicker("getDate"))+1);
                                               load_polyline(true);
                                             },
                                            });
            $("#end_datepicker").datepicker("setDate", endDateTime);
          }
        });
      }
      $(document).ready(initialize);
    </script>
  </head>
  <body>
    <div id="map_canvas"></div>
    <div class="demo">
      <div id="date_slider"></div>
      <input type="text" id="start_datepicker">
      <input type="text" id="end_datepicker">
      <label for="auto_zoom">Auto-Zoom</label><input type="checkbox" id="auto_zoom">
    </div>
  </body>
</html>
