<!DOCTYPE html>
<html>
  <head>
    <title>Google Maps JavaScript API v3 Example: Map Simple</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <style type="text/css">
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map_canvas {
        margin: 0;
        padding: 0;
        height: 80%
      };
    </style>
    <link rel="stylesheet" href="http://jqueryui.com/themes/base/jquery.ui.all.css">
    <!-- <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.5.min.js" type="text/javascript"></script> -->
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <!-- <script type="text/javascript" src=" https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script> -->
    <!-- <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js" type="text/javascript"></script> -->
    <script src="http://jqueryui.com/jquery-1.7.2.js"></script>
    <script src="http://jqueryui.com/ui/jquery.ui.core.js"></script>
    <script src="http://jqueryui.com/ui/jquery.ui.widget.js"></script>
    <script src="http://jqueryui.com/ui/jquery.ui.mouse.js"></script>
    <script src="http://jqueryui.com/ui/jquery.ui.slider.js"></script>
    <script src="http://jqueryui.com/ui/jquery.ui.datepicker.js"></script>
    <link rel="stylesheet" href="http://jqueryui.com/demos/demos.css">
    <script type="text/javascript">
      var map;
      var routePolyline;
      var gpsPoints = [];
      var tileFiles = {};
      var tilesLoaded = 0;
      var startDateTime;
      var endDateTime;
      function initialize() {
        var myOptions = {
          zoom: 0,
          center: new google.maps.LatLng(0, 0),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map_canvas'),
            myOptions);
        
        var gpsPath;
        
        $.ajaxSetup({ cache:false });

        function degreesToRadians(deg) {
          return deg * (Math.PI / 180);
        }
        
        function bound(value, opt_min, opt_max) {
          if (opt_min != null) value = Math.max(value, opt_min);
          if (opt_max != null) value = Math.min(value, opt_max);
          return value;
        }
        
        function fromLatLngToPoint(latLng, opt_point) {
          var point = opt_point || new google.maps.Point(0, 0);

          point.x = 128 + latLng.lng() * 256 / 360;

          // NOTE(appleton): Truncating to 0.9999 effectively limits latitude to
          // 89.189.  This is about a third of a tile past the edge of the world
          // tile.
          var siny = bound(Math.sin(degreesToRadians(latLng.lat())), -0.9999,
              0.9999);
          point.y = 128 + 0.5 * Math.log((1 + siny) / (1 - siny)) *
              -(256 / (2 * Math.PI));
          return point;
        };

        function load_polyline() {
          
          if(tilesLoaded > 40) {
            console.debug("reset tiles")
            $.each(tileFiles, function (key, val) {
              tileFiles[key] = 0;
            });
            gpsPoints = [];
            tilesLoaded = 0;
          }
          var start = Date.now();
          //console.debug("start at " + start);
          var zoom_level = map.getZoom();
          var bounds = map.getBounds();
          var sw = bounds.getSouthWest();
          var ne = bounds.getNorthEast();
          var sw_point = fromLatLngToPoint(sw);
          var ne_point = fromLatLngToPoint(ne);
          for(var current_zoom = 0;
              current_zoom <= zoom_level+1;
              current_zoom++) {
            //tile is 2048x2048.  2048 is 2**11.
            var current_west = bound(sw_point.x,0,255) << current_zoom;
            var current_south = bound(sw_point.y,0,255) << current_zoom;
            var current_east = bound(ne_point.x,0,255) << current_zoom;
            var current_north = bound(ne_point.y,0,255) << current_zoom;
            for(var i = Math.floor(current_west/2048); i <= Math.floor(current_east/2048); i++) {
              for(var j = Math.floor(current_north/2048); j <= Math.floor(current_south/2048); j++) {
                var tile_filename = "tiles/" + current_zoom + '/tile_' + current_zoom + '_' + i + '_' + j + '.json';
                if(!tileFiles.hasOwnProperty(tile_filename) || tileFiles[tile_filename]) {
                  continue;
                }
                tileFiles[tile_filename] = 1;
                $.getJSON(tile_filename, function(data) {
                  $.each(data, function(key, val) {
                    if(key == 'path')
                      tilesLoaded++;
                      var new_index = 0;
                      var gpsPoints_index = 0;
                      var newGpsPoints = [];
                      var newPath = [];
                      while(new_index < val.length && gpsPoints_index < gpsPoints.length) {
                        if(val[new_index][0] < gpsPoints[gpsPoints_index][0]) {
                          newGpsPoints.push(val[new_index]);
                          newPath.push(new google.maps.LatLng(val[new_index][2], val[new_index][3]));
                          new_index++;
                        } else if(val[new_index][0] > gpsPoints[gpsPoints_index][0]) {
                          newGpsPoints.push(gpsPoints[gpsPoints_index]);
                          newPath.push(new google.maps.LatLng(gpsPoints[gpsPoints_index][2], gpsPoints[gpsPoints_index][3]));
                          gpsPoints_index++;
                        } else {
                          //shouldn't arrive here ever
                          newGpsPoints.push(gpsPoints[gpsPoints_index]); //whichever
                          newPath.push(new google.maps.LatLng(gpsPoints[gpsPoints_index][2], gpsPoints[gpsPoints_index][3])); //whichever
                          gpsPoints_index++;
                          new_index++;
                        }
                      }
                      while(new_index < val.length) {
                        newGpsPoints.push(val[new_index]);
                        newPath.push(new google.maps.LatLng(val[new_index][2], val[new_index][3]));
                        new_index++;
                      }
                      while(gpsPoints_index < gpsPoints.length) {
                        newGpsPoints.push(gpsPoints[gpsPoints_index]);
                        newPath.push(new google.maps.LatLng(gpsPoints[gpsPoints_index][2], gpsPoints[gpsPoints_index][3]));
                        gpsPoints_index++;
                      }
                      gpsPoints = newGpsPoints;
                      routePolyline.setPath(newPath);
                  });
                })
              }
            }
          }
        }
        var polyOptions = {
          path: new google.maps.MVCArray(),
          strokeColor: '#000000',
          strokeOpacity: 1.0,
          strokeWeight: 3
        }
        routePolyline = new google.maps.Polyline(polyOptions);
        routePolyline.setMap(map);
        $.getJSON("tile_info.json", function(data) {
          $.each(data, function(key, val) {
            if(key == "tiles") {
              $.each(val, function (index, tile_filename) {
                tileFiles[tile_filename] = 0;
              });
            } else if(key == "start_datetime") {
              startDateTime = new Date(val);
            } else if(key == "end_datetime") {
              endDateTime = new Date(val);
            }
          });
          google.maps.event.addListener(map, 'bounds_changed', load_polyline);
          $(function() {
            var step = 1000*60*60*24;
            var max = Math.floor(endDateTime.getTime() / step) * step; //max is multiple of step
            var testDate = new Date(max);
            if(testDate.getDate() != endDateTime.getDate() || testDate.getMonth() != endDateTime.getMonth() || testDate.getYear() != endDateTime.getYear())
              max += step; //max is still multiple of step
            $("#date_slider").slider({animate: true, step: 1000*60*60*24, min: startDateTime.getTime(), max: endDateTime.getTime(), values: [startDateTime.getTime(), endDateTime.getTime()],
                                      slide: function(event, ui) {
                                        if($("#start_datepicker").datepicker("getDate").getTime() != $(this).slider('values', 0))
                                          $("#start_datepicker").datepicker("setDate", new Date($(this).slider('values', 0)));
                                        if($("#end_datepicker").datepicker("getDate").getTime() != $(this).slider('values', 1))
                                          $("#end_datepicker").datepicker("setDate", new Date($(this).slider('values', 1)));
                                      },
                                      change: function(event, ui) {
                                        if($("#start_datepicker").datepicker("getDate").getTime() != $(this).slider('values', 0))
                                          $("#start_datepicker").datepicker("setDate", new Date($(this).slider('values', 0)));
                                        if($("#end_datepicker").datepicker("getDate").getTime() != $(this).slider('values', 1))
                                          $("#end_datepicker").datepicker("setDate", new Date($(this).slider('values', 1)));
                                      }
                                     });
            $("#start_datepicker").datepicker({appendText: "(yyyy-mm-dd)", dateFormat: "yy-mm-dd", minDate: startDateTime, maxDate: endDateTime, defaultDate: startDateTime,
                                               onSelect: function(dateText, inst) {
                                                 if($("#start_datepicker").datepicker("getDate").getTime() != $("#date_slider").slider('values', 0))
                                                   $("#date_slider").slider("values", 0, $("#start_datepicker").datepicker("getDate").getTime());
                                               }
                                              });
            $("#start_datepicker").datepicker("setDate", startDateTime);
            $("#end_datepicker").datepicker({appendText: "(yyyy-mm-dd)", dateFormat: "yy-mm-dd", minDate: startDateTime, maxDate: endDateTime, defaultDate: endDateTime,
                                             onSelect: function(dateText, inst) {
                                                 if($("#end_datepicker").datepicker("getDate").getTime() != $("#date_slider").slider('values', 0))
                                                   $("#date_slider").slider("values", 1, $("#end_datepicker").datepicker("getDate").getTime());
                                             }
                                            });
            $("#end_datepicker").datepicker("setDate", endDateTime);
          });
        });
      }
      $(document).ready(initialize);
    </script>
  </head>
  <body>
    <div id="map_canvas"></div>
    <div class="demo">
      <div id="date_slider" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
        <a class="ui-slider-handle ui-state-default ui-corner-all" href="http://jqueryui.com/demos/slider/default.html#" style="left: 0%; "></a>
      </div>
      <input type="text" id="start_datepicker">
      <input type="text" id="end_datepicker">
    </div>
  </body>
</html>
